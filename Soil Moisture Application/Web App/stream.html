<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hello World Title</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
Hello World
<div id="graph"></div>
<p id="data"></p>
</body>
<!--<script src="graph.js"></script>-->
<script>
    function rand() {
        return Math.random();
    }

    var layout = {
        title: 'Temperature',
        xaxis: {
            title: 'Time',
            titlefont: {
                family: 'Courier New, monospace',
                size: 18,
                color: '#7f7f7f'
            }
        },
        yaxis: {
            title: 'Celsius',
            titlefont: {
                family: 'Courier New, monospace',
                size: 18,
                color: '#7f7f7f'
            }
        }
    };
    var lastDate;
    function stream(){
        var xhttp = new XMLHttpRequest();
        xhttp.open("GET", "http://18.221.30.192/newdata?date="+lastDate, true);
        xhttp.onreadystatechange = function(){
            if(xhttp.readyState === 4 && xhttp.status === 200){
                /*lastDate = new Date().toISOString();*/
                var records = JSON.parse(xhttp.responseText);
                /*document.getElementById("data").innerHTML = records;*/
                if(records.length !== 0){
                    lastDate = new Date().toISOString();
                    var tempsZero = [];
                    var timesZero = [];
                    var tempsOne = [];
                    var timesOne = [];
                    var tempsTwo = [];
                    var timesTwo = [];
                    for(var i = 0; i < records.length; i++){
                        switch(records[i].sensor) {
                            case 0:
                                tempsZero.push(records[i].value);
                                timesZero.push(records[i].date);
                                break;
                            case 1:
                                tempsOne.push(records[i].value);
                                timesOne.push(records[i].date);
                                break;
                            case 2:
                                tempsTwo.push(records[i].value);
                                timesTwo.push(records[i].date);
                                break;

                        }
                    }

                    var update;
                    if(tempsZero.length !== 0){
                        update = {
                            x: [timesZero],
                            y: [tempsZero]
                        };
                        Plotly.extendTraces('graph', update, [0]);
                    }
                    if(tempsOne.length !== 0){
                        update = {
                            x: [timesOne],
                            y: [tempsOne]
                        };
                        Plotly.extendTraces('graph', update, [1]);
                    }
                    if(tempsTwo.length !== 0){
                        update = {
                            x: [timesTwo],
                            y: [tempsTwo]
                        };
                        Plotly.extendTraces('graph', update, [2]);
                    }
                    /*document.getElementById("data").innerHTML = temps + " " + times;*/
                    /*var update = {
                        x: [times],
                        y: [temps]
                    };
                    Plotly.extendTraces('graph', update, [0]);*/
                }
            }
        };
        xhttp.send();

        /*var dates = [new Date(), new Date(), new Date()];
        var values = [30, 15, 25];

        var update = {
            x: [dates],
            y: [values]
        };
        Plotly.extendTraces('graph', update, [0]);*/
    }
    /*Plotly.plot('graph', [{
        y: [1,2,3].map(rand),
        mode: 'lines',
        line: {color: '#80CAF6'}
    }]);*/

    var cnt = 0;
    var xhttp = new XMLHttpRequest();
    xhttp.open("GET", "http://18.221.30.192/lastdata", true);
    xhttp.onreadystatechange = function(){
        if(xhttp.readyState == 4 && xhttp.status == 200){
            /*lastDate = new Date("2017-12-07T22:55:25.754Z").toISOString();*/
            lastDate = new Date().toISOString();
            /*console.log(xhttp.responseText);*/
            var records = JSON.parse(xhttp.responseText);
            var tempsZero = [];
            var timesZero = [];
            var tempsOne = [];
            var timesOne = [];
            var tempsTwo = [];
            var timesTwo = [];
            for(var i = 0; i < records[0].length; i++){
                tempsZero.push(records[0][i].value);
                timesZero.push(records[0][i].date);
                tempsOne.push(records[1][i].value);
                timesOne.push(records[1][i].date);
                tempsTwo.push(records[2][i].value);
                timesTwo.push(records[2][i].date);
            }

            /*var time = new Date();*/
            var sensorZeroTrace = {
                x: timesZero,
                y: tempsZero,
                mode: 'lines+markers',
                type: 'scatter',
                name: 'Sensor Zero'
                /*mode: 'lines',*/
                /*line: {color: '#80CAF6'}*/
            };

            var sensorOneTrace = {
                x: timesOne,
                y: tempsOne,
                mode: 'lines+markers',
                type: 'scatter',
                name: 'Sensor One'
                /*mode: 'lines',*/
                /*line: {color: '#80CAF6'}*/
            };

            var sensorTwoTrace = {
                x: timesTwo,
                y: tempsTwo,
                mode: 'lines+markers',
                type: 'scatter',
                name: 'Sensor One'
                /*mode: 'lines',*/
                /*line: {color: '#80CAF6'}*/
            };

            var allTraces = [sensorZeroTrace, sensorOneTrace, sensorTwoTrace];
            Plotly.plot('graph', allTraces, layout);

            var cnt = 0;
            var interval = setInterval(stream, 1000);
            document.getElementById("data").innerHTML = records[0].value + " " + records.length;
        }
    };
    xhttp.send();
</script>
</html>